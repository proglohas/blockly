<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Blockly IDE å®Œæ•´ç‰ˆ</title>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<script src="https://unpkg.com/@blockly/blockly/javascript_compressed.js"></script>
<style>
html, body { height: 100%; margin:0; padding:0; font-family:sans-serif; overflow:hidden; }
#toolbar { height:40px; background:#eee; display:flex; align-items:center; padding:0 10px; box-sizing:border-box; border-bottom:1px solid #ccc;}
#toolbar button { margin-right:10px; }
#main { display:flex; height:calc(100% - 40px); }
#blocklyDiv { flex:0 0 50%; height:100%; min-width:100px; max-width:calc(100% - 100px); transition:none; }
#resizer { width:6px; cursor:col-resize; background:#ccc; flex-shrink:0; }
#rightPanel { flex:1; display:flex; flex-direction:column; height:100%; min-width:100px; }
.panel-section { padding:10px; box-sizing:border-box; font-family:monospace; display:flex; flex-direction:column; overflow:hidden; }
#inputPanel, #ansPanel, #outputPanel { flex-grow:0; flex-shrink:0; border-bottom:1px solid #ccc; background:#f8f8f8; }
#outputPanel { background:#000; color:#0f0; overflow-y:auto; white-space:pre-wrap; border-bottom:none; }
.v-resizer { height:6px; width:100%; background:#aaa; cursor:row-resize; flex-shrink:0; }
.panel-caption { font-size:0.9em; font-weight:bold; margin-bottom:5px; color:#666; text-transform:uppercase; flex-shrink:0; }
#outputPanel .panel-caption { color:#eee; }
#inputContent, #ansContent { flex-grow:1; border:1px solid #ddd; padding:5px; overflow:auto; background:white; resize:none; }
#outputContent { flex-grow:1; background:transparent; border:none; padding:0; }

#shareModal, #descModal {
    position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000;
}
#modalContent {
    background:white; padding:25px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2); width:90%; max-width:500px; text-align:center;
}
#descContent { text-align:left; white-space:pre-wrap; max-height:400px; overflow:auto; }
.modal-buttons button { padding:10px 15px; margin:5px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.modal-buttons button:first-child { background:#007bff; color:white; }
.modal-buttons button:last-child { background:#ccc; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="exportXML()">åŒ¯å‡º XML</button>
  <button onclick="importXML()">åŒ¯å…¥ XML</button>
  <button onclick="shareLink()">åˆ†äº«</button>
  <button onclick="runCode()">åŸ·è¡Œç¨‹å¼ç¢¼</button>
  <button id="langButton" onclick="switchLanguage()">åˆ‡æ›èªè¨€ (English)</button>
  <button onclick="showProblemDescription()">é¡Œç›®èªªæ˜</button>
</div>

<div id="main">
  <div id="blocklyDiv"></div>
  <div id="resizer"></div>

  <div id="rightPanel">
    <div id="inputPanel" class="panel-section">
      <div class="panel-caption">Input</div>
      <textarea id="inputContent" rows="5"></textarea>
    </div>
    <div class="v-resizer"></div>
    <div id="ansPanel" class="panel-section">
      <div class="panel-caption">Answer</div>
      <textarea id="ansContent" rows="5"></textarea>
    </div>
    <div class="v-resizer"></div>
    <div id="outputPanel" class="panel-section">
      <div class="panel-caption">Output</div>
      <pre id="outputContent">ç¨‹å¼åŸ·è¡Œçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</pre>
    </div>
  </div>
</div>

<!-- é¡Œç›®èªªæ˜ Modal -->
<div id="descModal" style="display:none;">
  <div id="modalContent">
    <h3>é¡Œç›®èªªæ˜</h3>
    <pre id="descContent"></pre>
    <div style="text-align:right;"><button onclick="closeDescModal()">é—œé–‰</button></div>
  </div>
</div>

<!-- åˆ†äº« Modal -->
<div id="shareModal" style="display:none;">
  <div id="modalContent">
    <h3>ğŸ‰ å°ˆæ¡ˆåˆ†äº«é€£çµ</h3>
    <p>æ­¤é€£çµåŒ…å«æ‚¨çš„ Blockly å°ˆæ¡ˆå…§å®¹ã€‚è«‹æ³¨æ„ï¼Œç›´æ¥å¾æœ¬åœ°é–‹å•Ÿå°‡ç„¡æ•ˆï¼</p>
    <input type="text" id="shareUrlInput" readonly>
    <div class="modal-buttons">
        <button onclick="copyShareUrl()">è¤‡è£½é€£çµ</button>
        <button onclick="closeModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
let workspace, currentLanguage='zh-hant', isResizing=false, lastBlocklyWidth='0 0 50%';
const blocklyDiv = document.getElementById('blocklyDiv');
const main = document.getElementById('main');
const outputContent = document.getElementById('outputContent');

// ====== Blockly å·¥å…·ç®± ======
function getToolbox(lang){
  const categories = { 'zh-hant':['é‚è¼¯','è¿´åœˆ','æ•¸å­¸','æ–‡å­—','æ¸…å–®','è®Šæ•¸','å‡½å¼'], 'en':['Logic','Loops','Math','Text','Lists','Variables','Functions'] };
  const names = categories[lang]||categories['zh-hant'];
  return {
    "kind":"categoryToolbox",
    "contents":[
      {"kind":"category","name":names[0],"colour":"210","contents":[{"kind":"block","type":"controls_if"},{"kind":"block","type":"logic_compare"},{"kind":"block","type":"logic_operation"},{"kind":"block","type":"logic_boolean"},{"kind":"block","type":"logic_negate"},{"kind":"block","type":"logic_null"},{"kind":"block","type":"logic_ternary"}]},
      {"kind":"category","name":names[1],"colour":"120","contents":[{"kind":"block","type":"controls_repeat_ext"},{"kind":"block","type":"controls_whileUntil"},{"kind":"block","type":"controls_for"},{"kind":"block","type":"controls_forEach"},{"kind":"block","type":"controls_flow_statements"}]},
      {"kind":"category","name":names[2],"colour":"230","contents":[{"kind":"block","type":"math_number"},{"kind":"block","type":"math_arithmetic"},{"kind":"block","type":"math_single"},{"kind":"block","type":"math_trig"},{"kind":"block","type":"math_constant"},{"kind":"block","type":"math_number_property"},{"kind":"block","type":"math_round"},{"kind":"block","type":"math_on_list"},{"kind":"block","type":"math_modulo"},{"kind":"block","type":"math_constrain"},{"kind":"block","type":"math_random_int"},{"kind":"block","type":"math_random_float"},{"kind":"block","type":"math_atan2"}]},
      {"kind":"category","name":names[3],"colour":"160","contents":[{"kind":"block","type":"text"},{"kind":"block","type":"text_join"},{"kind":"block","type":"text_append"},{"kind":"block","type":"text_length"},{"kind":"block","type":"text_isEmpty"},{"kind":"block","type":"text_indexOf"},{"kind":"block","type":"text_charAt"},{"kind":"block","type":"text_getSubstring"},{"kind":"block","type":"text_changeCase"},{"kind":"block","type":"text_trim"},{"kind":"block","type":"text_print"},{"kind":"block","type":"text_prompt_ext"}]},
      {"kind":"category","name":names[4],"colour":"300","contents":[{"kind":"block","type":"lists_create_with"},{"kind":"block","type":"lists_repeat"},{"kind":"block","type":"lists_length"},{"kind":"block","type":"lists_isEmpty"},{"kind":"block","type":"lists_indexOf"},{"kind":"block","type":"lists_getIndex"},{"kind":"block","type":"lists_setIndex"},{"kind":"block","type":"lists_getSublist"},{"kind":"block","type":"lists_split"},{"kind":"block","type":"lists_sort"}]},
      {"kind":"category","name":names[5],"colour":"330","custom":"VARIABLE"},
      {"kind":"category","name":names[6],"colour":"290","custom":"PROCEDURE"}
    ]
  };
}

// ====== é¡Œç›®èªªæ˜åŠŸèƒ½ ======
function showProblemDescription() {
    document.getElementById('descContent').textContent = window.problemDescription || "é¡Œç›®èªªæ˜ç„¡æ³•è¼‰å…¥";
    document.getElementById('descModal').style.display = 'flex';
}
function closeDescModal() {
    document.getElementById('descModal').style.display = 'none';
}

// ====== èªè¨€åˆ‡æ› ======
function loadLanguage(lang){
  currentLanguage = lang;
  let xmlText='';
  if(workspace){ xmlText = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace)); workspace.dispose(); }
  const oldScript=document.getElementById('langScript'); if(oldScript) oldScript.remove();
  const script=document.createElement('script');
  script.src=`https://unpkg.com/blockly/msg/${lang}.js`; script.id='langScript';
  script.onload=()=>{
    document.getElementById('langButton').textContent=(lang==='zh-hant')?'åˆ‡æ›èªè¨€ (English)':'Switch Language (ä¸­æ–‡)';
    workspace=Blockly.inject('blocklyDiv',{
      toolbox:getToolbox(lang),
      scrollbars:true, trashcan:true, collapse:true,
      grid:{spacing:20,length:3,colour:'#ccc',snap:true},
      locale:lang,
      zoom:{controls:true,wheel:false,startScale:1,maxScale:3,minScale:0.3,scaleSpeed:1.2}
    });
    if(xmlText){ try{ Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xmlText),workspace); } catch(e){console.warn(e);} }
    Blockly.svgResize(workspace);
  };
  document.head.appendChild(script);
}
function switchLanguage(){ loadLanguage(currentLanguage==='zh-hant'?'en':'zh-hant'); }

// ====== å·¦å³æ‹–æ›³ ======
function enableResize(){
  const resizer=document.getElementById('resizer');
  resizer.addEventListener('mousedown',e=>{isResizing=true; document.body.style.userSelect='none'; document.body.style.cursor='col-resize';});
  document.addEventListener('mousemove',e=>{
    if(!isResizing) return;
    let w=e.clientX-main.offsetLeft;
    const min=100;
    if(w<min) w=min; else if(main.offsetWidth-w-resizer.offsetWidth<min) w=main.offsetWidth-min-resizer.offsetWidth;
    blocklyDiv.style.flex='0 0 '+w+'px'; lastBlocklyWidth='0 0 '+w+'px';
    if(workspace) Blockly.svgResize(workspace);
  });
  document.addEventListener('mouseup',e=>{if(isResizing){isResizing=false; document.body.style.userSelect='auto'; document.body.style.cursor='default';}});
}

// ====== å³å´å‚ç›´æ‹–æ›³ ======
function enableVResize(){
  const vResizers=document.querySelectorAll('.v-resizer');
  vResizers.forEach(vResizer=>{
    let isV=false;
    const prev=vResizer.previousElementSibling, next=vResizer.nextElementSibling;
    vResizer.addEventListener('mousedown',e=>{isV=true; document.body.style.userSelect='none'; document.body.style.cursor='row-resize';});
    document.addEventListener('mousemove',e=>{
      if(!isV) return;
      const totalH=prev.offsetHeight+next.offsetHeight+vResizer.offsetHeight;
      let newH=e.clientY-prev.getBoundingClientRect().top;
      if(newH<50) newH=50;
      if(totalH-newH-vResizer.offsetHeight<50) newH=totalH-50-vResizer.offsetHeight;
      prev.style.height=newH+'px'; next.style.height=(totalH-newH-vResizer.offsetHeight)+'px';
    });
    document.addEventListener('mouseup',e=>{if(isV){isV=false; document.body.style.userSelect='auto'; document.body.style.cursor='default';}});
  });
}

// ====== Blockly ç›¸é—œåŠŸèƒ½ ======
function runCode(){
  outputContent.textContent="åŸ·è¡Œä¸­...\n";
  const inputLines=document.getElementById('inputContent').value.split('\n').map(l=>l.trimEnd()).filter(l=>l!=="");
  let idx=0;
  const start=performance.now();
  const customAlert=msg=>{outputContent.textContent+=msg+'\n'; outputContent.scrollTop=outputContent.scrollHeight;};
  const customPrompt=(msg,def)=>{
    if(idx<inputLines.length){ const v=inputLines[idx]; idx++; return v; }
    outputContent.textContent+=`[Input exhausted, using default/null: ${def}]\n`; outputContent.scrollTop=outputContent.scrollHeight; return def??null;
  };
  const origAlert=window.alert, origPrompt=window.prompt;
  window.alert=customAlert; window.prompt=customPrompt;
  try{ eval(Blockly.JavaScript.workspaceToCode(workspace)); outputContent.textContent+="\n--- ç¨‹å¼åŸ·è¡Œå®Œç•¢ ---"; }
  catch(e){ outputContent.textContent+="\n\n!!! ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤:\n"+e; }
  finally{ window.alert=origAlert; window.prompt=origPrompt;
    const end=performance.now(); outputContent.textContent+=`\nâ± åŸ·è¡Œæ™‚é–“ï¼š${((end-start)/1000).toFixed(4)} ç§’`;
    outputContent.scrollTop=outputContent.scrollHeight;
  }
}

function exportXML(){
  if(!workspace)return alert("å·¥ä½œå€å°šæœªè¼‰å…¥");
  let xml=Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(workspace));
  const blob=new Blob([xml],{type:"text/xml"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="blockly.xml"; a.click();
  URL.revokeObjectURL(a.href);
}
function importXML(){
  const input=document.createElement('input'); input.type='file'; input.accept='.xml';
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file) return;
    file.text().then(text=>{try{ Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(text),workspace); alert("åŒ¯å…¥æˆåŠŸï¼"); } catch(err){alert("åŒ¯å…¥å¤±æ•—: "+err);} });
  }; input.click();
}
function shareLink(){
  if(!workspace) return alert("å·¥ä½œå€å°šæœªè¼‰å…¥");
  const encoded=btoa(Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace)));
  const url=location.origin+location.pathname+"#xml="+encoded;
  document.getElementById('shareUrlInput').value=url;
  document.getElementById('shareModal').style.display='flex';
}
function closeModal(){ document.getElementById('shareModal').style.display='none'; }
function copyShareUrl(){
  const input=document.getElementById('shareUrlInput'); input.select(); input.setSelectionRange(0,99999);
  try{ navigator.clipboard.writeText(input.value).then(()=>alert("å·²è¤‡è£½é€£çµ")); } catch(e){ document.execCommand('copy'); alert("å·²è¤‡è£½é€£çµ"); }
}

// ====== è¼‰å…¥é¡Œç›® input/output/description ======
window.onload=()=>{
  enableResize(); enableVResize(); loadLanguage('zh-hant'); blocklyDiv.style.flex=lastBlocklyWidth;

  const rightPanel=document.getElementById('rightPanel');
  const panels=[document.getElementById('inputPanel'),document.getElementById('ansPanel'),document.getElementById('outputPanel')];
  const totalH=rightPanel.clientHeight;
  const resH=document.querySelectorAll('.v-resizer').length*6;
  const h=(totalH-resH)/panels.length;
  panels.forEach(p=>p.style.height=h+'px');

  // å¾ URL å–å¾—é¡Œç›® id
  const params=new URLSearchParams(location.search);
  const id=params.get('id');
  if(id){
    // input
    fetch(`set/${id}.in`).then(r=>r.text()).then(t=>{document.getElementById('inputContent').value=t;});
    // answer
    fetch(`set/${id}.out`).then(r=>r.text()).then(t=>{document.getElementById('ansContent').value=t;});
    // description
    fetch(`set/${id}.xml`).then(r=>r.text()).then(t=>{
      const parser=new DOMParser();
      const xmlDoc=parser.parseFromString(t,"text/xml");
      const descNode=xmlDoc.getElementsByTagName("description")[0];
      window.problemDescription=descNode?descNode.textContent:"ç„¡é¡Œç›®èªªæ˜";
    });
  }

  // å¾ URL hash è¼‰å…¥ Blockly XML
  if(location.hash.startsWith("#xml=")){
    setTimeout(()=>{try{ Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(atob(location.hash.slice(5))),workspace); } catch(e){console.error(e);} },500);
  }
};
</script>
</body>
</html>






