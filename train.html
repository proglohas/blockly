<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Blockly IDE å®Œæ•´ç‰ˆ</title>

<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<script src="https://unpkg.com/@blockly/blockly/javascript_compressed.js"></script>

<style>
html, body {
    height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif;
}
#toolbar {
    height: 40px; background: #eee; border-bottom: 1px solid #ccc;
    display: flex; align-items: center; padding: 0 10px; box-sizing: border-box;
}
#toolbar button { margin-right: 10px; }

#main { display: flex; height: calc(100% - 40px); }
#blocklyDiv { flex: 0 0 50%; height: 100%; min-width: 100px; max-width: calc(100% - 100px); transition: none; }
#resizer { width:6px; height:100%; background:#ccc; cursor:col-resize; flex-shrink:0; }

#rightPanel { flex:1; display:flex; flex-direction:column; height:100%; min-width:100px; }
.panel-section { padding:10px; box-sizing:border-box; font-family:monospace; display:flex; flex-direction:column; overflow:hidden; }
#inputPanel, #ansPanel, #outputPanel { flex-grow:0; flex-shrink:0; border-bottom:1px solid #ccc; background:#f8f8f8; }
#outputPanel { background:#000; color:#0f0; overflow-y:auto; white-space:pre-wrap; border-bottom:none; }
.v-resizer { height:6px; width:100%; background:#aaa; cursor:row-resize; flex-shrink:0; }
.panel-caption { font-size:0.9em; font-weight:bold; margin-bottom:5px; color:#666; text-transform:uppercase; flex-shrink:0; }
#outputPanel .panel-caption { color:#eee; }
#inputContent, #ansContent { flex-grow:1; border:1px solid #ddd; padding:5px; overflow:auto; background:white; resize:none; }
#outputContent { flex-grow:1; background:transparent; border:none; padding:0; }

#shareModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
#modalContent { background:white; padding:25px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2); width:90%; max-width:500px; text-align:center; }
#shareUrlInput { width:95%; padding:8px; margin:15px 0; border:1px solid #ccc; border-radius:4px; font-size:0.9em; cursor:text; user-select: all; }
.modal-buttons button { padding:10px 15px; margin:5px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.modal-buttons button:first-child { background:#007bff; color:white; }
.modal-buttons button:last-child { background:#ccc; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="exportXML()">åŒ¯å‡º XML</button>
  <button onclick="importXML()">åŒ¯å…¥ XML</button>
  <button onclick="shareLink()">åˆ†äº«</button>
  <button onclick="runCode()">åŸ·è¡Œç¨‹å¼ç¢¼</button>
  <button id="langButton" onclick="switchLanguage()">åˆ‡æ›èªè¨€ (English)</button>
  <button onclick="showProblemDescription()">é¡Œç›®èªªæ˜</button>
</div>

<div id="main">
  <div id="blocklyDiv"></div>
  <div id="resizer"></div>

  <div id="rightPanel">
    <div id="inputPanel" class="panel-section">
        <div class="panel-caption">Input (æ¯è¡Œè¦–ç‚ºä¸€æ¬¡è¼¸å…¥):</div>
        <textarea id="inputContent" placeholder="åœ¨æ­¤è¼¸å…¥ç¨‹å¼æ‰€éœ€çš„è³‡æ–™ï¼Œæ¯è¡Œä¸€å€‹å€¼..." rows="5"></textarea>
    </div>
    <div class="v-resizer"></div>
    <div id="ansPanel" class="panel-section">
        <div class="panel-caption">Answer (æ¨™æº–ç­”æ¡ˆ):</div>
        <textarea id="ansContent" placeholder="" rows="5"></textarea>
    </div>
    <div class="v-resizer"></div>
    <div id="outputPanel" class="panel-section">
        <div class="panel-caption">Output:</div>
        <pre id="outputContent">ç¨‹å¼åŸ·è¡Œçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</pre>
    </div>
  </div>
</div>

<div id="shareModal" style="display:none;">
  <div id="modalContent">
    <h3>ğŸ‰ å°ˆæ¡ˆåˆ†äº«é€£çµ</h3>
    <p>æ­¤é€£çµåŒ…å«æ‚¨çš„ Blockly å°ˆæ¡ˆå…§å®¹ã€‚è«‹æ³¨æ„ï¼Œç›´æ¥å¾æœ¬åœ°é–‹å•Ÿå°‡ç„¡æ•ˆï¼</p>
    <input type="text" id="shareUrlInput" readonly>
    <div class="modal-buttons">
        <button onclick="copyShareUrl()">è¤‡è£½é€£çµ</button>
        <button onclick="closeModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
let workspace, currentLanguage='zh-hant', isResizing=false, lastBlocklyWidth='0 0 50%';
let currentProblemDesc="", currentProblemName="";
const blocklyDiv = document.getElementById('blocklyDiv'), main = document.getElementById('main'), outputContent=document.getElementById('outputContent');

// ====== å·¥å…·ç®±è¨­å®š ======
function getToolbox(lang){
  const categories = { 'zh-hant':['é‚è¼¯','è¿´åœˆ','æ•¸å­¸','æ–‡å­—','æ¸…å–®','è®Šæ•¸','å‡½å¼'], 'en':['Logic','Loops','Math','Text','Lists','Variables','Functions'] };
  const names = categories[lang]||categories['zh-hant'];
  return {
    "kind":"categoryToolbox",
    "contents":[
      {"kind":"category","name":names[0],"colour":"210","contents":[{"kind":"block","type":"controls_if"},{"kind":"block","type":"logic_compare"},{"kind":"block","type":"logic_operation"},{"kind":"block","type":"logic_boolean"},{"kind":"block","type":"logic_negate"},{"kind":"block","type":"logic_null"},{"kind":"block","type":"logic_ternary"}]},
      {"kind":"category","name":names[1],"colour":"120","contents":[{"kind":"block","type":"controls_repeat_ext"},{"kind":"block","type":"controls_whileUntil"},{"kind":"block","type":"controls_for"},{"kind":"block","type":"controls_forEach"},{"kind":"block","type":"controls_flow_statements"}]},
      {"kind":"category","name":names[2],"colour":"230","contents":[{"kind":"block","type":"math_number"},{"kind":"block","type":"math_arithmetic"},{"kind":"block","type":"math_single"},{"kind":"block","type":"math_trig"},{"kind":"block","type":"math_constant"},{"kind":"block","type":"math_number_property"},{"kind":"block","type":"math_round"},{"kind":"block","type":"math_on_list"},{"kind":"block","type":"math_modulo"},{"kind":"block","type":"math_constrain"},{"kind":"block","type":"math_random_int"},{"kind":"block","type":"math_random_float"},{"kind":"block","type":"math_atan2"}]},
      {"kind":"category","name":names[3],"colour":"160","contents":[{"kind":"block","type":"text"},{"kind":"block","type":"text_join"},{"kind":"block","type":"text_append"},{"kind":"block","type":"text_length"},{"kind":"block","type":"text_isEmpty"},{"kind":"block","type":"text_indexOf"},{"kind":"block","type":"text_charAt"},{"kind":"block","type":"text_getSubstring"},{"kind":"block","type":"text_changeCase"},{"kind":"block","type":"text_trim"},{"kind":"block","type":"text_print"},{"kind":"block","type":"text_prompt_ext"}]},
      {"kind":"category","name":names[4],"colour":"300","contents":[{"kind":"block","type":"lists_create_with"},{"kind":"block","type":"lists_repeat"},{"kind":"block","type":"lists_length"},{"kind":"block","type":"lists_isEmpty"},{"kind":"block","type":"lists_indexOf"},{"kind":"block","type":"lists_getIndex"},{"kind":"block","type":"lists_setIndex"},{"kind":"block","type":"lists_getSublist"},{"kind":"block","type":"lists_split"},{"kind":"block","type":"lists_sort"}]},
      {"kind":"category","name":names[5],"colour":"330","custom":"VARIABLE"},
      {"kind":"category","name":names[6],"colour":"290","custom":"PROCEDURE"}
    ]
  };
}

// ====== èªè¨€åˆ‡æ› ======
function loadLanguage(lang){
  currentLanguage = lang;
  let xmlText='';
  if(workspace){ xmlText = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace)); workspace.dispose(); }
  const oldScript=document.getElementById('langScript'); if(oldScript) oldScript.remove();
  const script=document.createElement('script');
  script.src=`https://unpkg.com/blockly/msg/${lang}.js`; script.id='langScript';
  script.onload=()=>{
    document.getElementById('langButton').textContent=(lang==='zh-hant')?'åˆ‡æ›èªè¨€ (English)':'Switch Language (ä¸­æ–‡)';
    workspace=Blockly.inject('blocklyDiv',{
      toolbox:getToolbox(lang),
      scrollbars:true, trashcan:true, collapse:true,
      grid:{spacing:20,length:3,colour:'#ccc',snap:true},
      locale:lang,
      zoom:{controls:true,wheel:false,startScale:1,maxScale:3,minScale:0.3,scaleSpeed:1.2}
    });
    if(xmlText){ try{ Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xmlText),workspace); } catch(e){console.warn(e);} }
    Blockly.svgResize(workspace);
  };
  document.head.appendChild(script);
}
function switchLanguage(){ loadLanguage(currentLanguage==='zh-hant'?'en':'zh-hant'); }

// ====== é¡Œç›®èªªæ˜æŒ‰éˆ• ======
function showProblemDescription(){
  if(!currentProblemName && !currentProblemDesc){
    alert("å°šæœªè¼‰å…¥é¡Œç›®æè¿°ï¼");
    return;
  }
  const content = `<h3>${currentProblemName}</h3><p>${currentProblemDesc}</p>`;
  const modal = document.createElement('div');
  modal.style.position='fixed';
  modal.style.top='0';
  modal.style.left='0';
  modal.style.width='100%';
  modal.style.height='100%';
  modal.style.background='rgba(0,0,0,0.5)';
  modal.style.display='flex';
  modal.style.justifyContent='center';
  modal.style.alignItems='center';
  modal.style.zIndex='2000';
  modal.innerHTML = `
    <div style="background:white;padding:20px;border-radius:8px;max-width:500px;width:90%;text-align:left;">
      ${content}
      <div style="text-align:right;margin-top:10px;">
        <button onclick="this.parentElement.parentElement.remove()">é—œé–‰</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// ====== è¼¸å…¥ / æ¨™æº–ç­”æ¡ˆè‡ªå‹•è¼‰å…¥ ======
window.onload=()=>{
  enableResize(); enableVResize(); loadLanguage('zh-hant'); blocklyDiv.style.flex=lastBlocklyWidth;

  // è‡ªå‹•å¹³åˆ†å³å´ä¸‰é¢æ¿é«˜åº¦
  const rightPanel=document.getElementById('rightPanel');
  const panels=[document.getElementById('inputPanel'),document.getElementById('ansPanel'),document.getElementById('outputPanel')];
  const totalH=rightPanel.clientHeight;
  const resH=document.querySelectorAll('.v-resizer').length*6;
  const h=(totalH-resH)/panels.length;
  panels.forEach(p=>p.style.height=h+'px');

  // ====== è®€å– URL id ======
  const urlParams = new URLSearchParams(window.location.search);
  const problemId = urlParams.get('id');
  if(problemId){
    // Input
    fetch(`set/${problemId}.in`)
      .then(r=>r.text())
      .then(txt=>document.getElementById('inputContent').value = txt)
      .catch(e=>console.warn(`ç„¡æ³•è®€å– ${problemId}.in`, e));
    // Answer
    fetch(`set/${problemId}.out`)
      .then(r=>r.text())
      .then(txt=>document.getElementById('ansContent').value = txt)
      .catch(e=>console.warn(`ç„¡æ³•è®€å– ${problemId}.out`, e));
    // é¡Œç›®æè¿°
    fetch(`set/${problemId}.xml`)
      .then(r=>r.text())
      .then(str=>(new DOMParser()).parseFromString(str,'text/xml'))
      .then(xml=>{
        currentProblemName = xml.getElementsByTagName('name')[0]?.textContent || problemId;
        currentProblemDesc = xml.getElementsByTagName('desc')[0]?.textContent || "";
      })
      .catch(e=>console.warn(`ç„¡æ³•è®€å– ${problemId}.xml`, e));
  }

  // å¾ URL hash è¼‰å…¥ Blockly XML
  if(location.hash.startsWith("#xml=")){
    setTimeout(()=>{try{ Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(atob(location.hash.slice(5))),workspace); } catch(e){console.error(e);} },500);
  }
};

// ====== Blockly ç›¸é—œåŠŸèƒ½ ======
// ... å…¶ä»– runCode / exportXML / importXML / shareLink / resize ç­‰å‡½æ•¸ä¿ç•™åŸæœ¬ç¨‹å¼ç¢¼ ...
</script>
</body>
</html>
